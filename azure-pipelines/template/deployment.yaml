parameters:
  - name: env
    type: string

  - name: azureDevOpsEnv
    type: string

  - name: stageCondition
    type: string
    default: |
      and(
        succeeded(),
        in(variables['Build.SourceBranch'], 'refs/heads/master', 'refs/heads/main')
      )

  - name: stageDependsOn
    type: object
    default: []

  - name: helmArtifactName
    type: string

  - name: buildDockerJobName
    type: string
    default: 'BuildAppImage'

  - name: buildDockerStageName
    type: string
    default: 'BuildImages'

  - name: helmValuesFile
    type: string


stages:
  - stage: ${{ parameters.env }}
    condition: ${{ parameters.stageCondition }}
    dependsOn: ${{ parameters.stageDependsOn }}
    pool:
      vmImage: 'ubuntu-latest'
    variables:
      chartPath: '${{ parameters.helmArtifactName }}/chart'
      fullImageNameAndTag: $[ stageDependencies.${{ parameters.buildDockerStageName }}.${{ parameters.buildDockerJobName }}.outputs['setFullImageNameAndTag.fullImageNameAndTag'] ]
    jobs:
      - deployment: Linode
        environment: ${{ parameters.azureDevOpsEnv }}
        strategy:
          runOnce:
            deploy:
              steps:
                - download: none

                - task: DownloadPipelineArtifact@2
                  inputs:
                    patterns: ${{ parameters.helmArtifactName }}/**

                - task: qetza.replacetokens.replacetokens-task.replacetokens@3
                  displayName: Replace values in files
                  inputs:
                    rootDirectory: $(Pipeline.Workspace)
                    targetFiles: |
                      $(chartPath)/values/${{ parameters.helmValuesFile }}
                    encoding: auto
                    writeBOM: true
                    actionOnMissing: fail
                    keepToken: false
                    tokenPrefix: '#{'
                    tokenSuffix: '}#'
                    useLegacyPattern: false
                    enableTelemetry: true

